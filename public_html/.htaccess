# InfinityFree Root Configuration
RewriteEngine On

# MIME Types for Assets (Critical for InfinityFree)
AddType text/css .css
AddType application/javascript .js
AddType application/json .json
AddType image/svg+xml .svg
AddType font/woff2 .woff2
AddType font/woff .woff
AddType font/ttf .ttf

# Cache Control for Assets
<FilesMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg)$">
    ExpiresActive On
    ExpiresDefault "access plus 1 year"
    Header append Cache-Control "public"
</FilesMatch>

# CORS Headers for InfinityFree (Critical for API access)
Header always set Access-Control-Allow-Origin "*"
Header always set Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
Header always set Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization, X-Authorization, Bearer"
Header always set Access-Control-Max-Age "3600"

# Force CORS headers before any processing
Header always set Access-Control-Allow-Origin "*"
Header always set Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
Header always set Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization, X-Authorization, Bearer"
Header always set Access-Control-Max-Age "3600"

# Handle preflight OPTIONS requests immediately
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule .* - [R=200,L]

# InfinityFree method override - intercept PUT/DELETE and convert to POST
RewriteCond %{REQUEST_METHOD} ^(PUT|DELETE)$
RewriteRule ^api/admin/questions/([0-9]+)/?$ /api/api/admin/questions.php?id=$1&_method=%1 [QSA,L,E=REQUEST_METHOD:POST]

RewriteCond %{REQUEST_METHOD} ^(PUT|DELETE)$
RewriteRule ^api/admin/test-codes/([0-9]+)/?$ /api/api/admin/test-codes.php?id=$1&_method=%1 [QSA,L,E=REQUEST_METHOD:POST]

# Standard API routing for InfinityFree
RewriteRule ^api/admin/questions/bulk/?$ /api/api/admin/questions/bulk.php [QSA,L]
RewriteRule ^api/admin/questions/([0-9]+)/?$ /api/api/admin/questions.php?id=$1 [QSA,L]
RewriteRule ^api/admin/questions/?$ /api/api/admin/questions.php [QSA,L]
RewriteRule ^api/admin/test-codes/bulk/?$ /api/api/admin/test-codes.php [QSA,L]
RewriteRule ^api/admin/test-codes/([0-9]+)/?$ /api/api/admin/test-codes.php?id=$1 [QSA,L]
RewriteRule ^api/admin/test-codes/?$ /api/api/admin/test-codes.php [QSA,L]
RewriteRule ^api/admin/teachers/?$ /api/api/admin/teachers.php [QSA,L]

# Fallback to main router for other API requests
RewriteRule ^api/(.*)$ /api/index.php [QSA,L]

# Security Headers
Header always set X-Content-Type-Options "nosniff"
Header always set X-Frame-Options "SAMEORIGIN"
Header always set X-XSS-Protection "1; mode=block"

# Hide .env files
<Files ".env*">
    Order allow,deny
    Deny from all
</Files>

# Disable directory browsing
Options -Indexes

# API Routing for InfinityFree (Handle before SPA routing)
RewriteCond %{REQUEST_URI} ^/api/
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^api/(.*)$ /api/$1 [QSA,L]

# React Router SPA Configuration
# Handle client-side routing - redirect all requests to index.html unless they're files/directories
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/api/
RewriteRule ^(.+)$ /index.html [QSA,L]

# PHP Configuration
php_value max_execution_time 300
php_value memory_limit 128M